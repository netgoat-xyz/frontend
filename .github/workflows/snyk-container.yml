name: Snyk Container

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '19 16 * * 1'

permissions:
  contents: read

jobs:
  snyk:
    permissions:
      contents: read
      security-events: write # required for uploading SARIF results
      actions: read
    runs-on: self-hosted
    steps:
    - uses: actions/checkout@v4
    
    # Ensure Docker build is successful
    - name: Build a Docker image
      run: docker build -t netgoat/frontend .
      
    # Use Snyk action to scan the image and generate snyk.sarif
    - name: Run Snyk to check Docker image for vulnerabilities
      continue-on-error: true # Allow subsequent steps to run even if Snyk finds vulns
      uses: snyk/actions/docker@14818c4695ecc4045f33c9cee9e795a788711ca4
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        image: netgoat/frontend
        args: --file=Dockerfile
        
    # --- START: SARIF FIX ---
    # Fix the 'invalid security severity value' error by replacing 'null' with '0.0'
    - name: Fix SNYK SARIF for Code Scanning (Requires 'jq' to be installed on runner)
      run: |
        if [ -f snyk.sarif ]; then
          # Check if 'jq' is installed before attempting to use it
          if ! command -v jq &> /dev/null
          then
              echo "Warning: 'jq' command not found. Cannot fix SARIF file error."
              echo "Please install 'jq' on your self-hosted runner to resolve the 'invalid security severity value' error."
          else
              echo "Fixing SARIF file: Replacing null security-severity with 0.0"
              jq '(.runs[].tool.driver.rules[] | select(."security-severity" == null))."security-severity" = 0.0' snyk.sarif > snyk_fixed.sarif
              mv snyk_fixed.sarif snyk.sarif
          fi
        else
          echo "Warning: snyk.sarif file was not created, skipping SARIF fix."
        fi
    # --- END: SARIF FIX ---
      
    # Update to v4 and use the fixed SARIF file
    - name: Upload result to GitHub Code Scanning
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: snyk.sarif